<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>GateWay | Study Notes</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/study/logo.svg">
    <meta name="description" content="">
    
    <link rel="preload" href="/study/assets/css/0.styles.7070726e.css" as="style"><link rel="preload" href="/study/assets/js/app.18d9f44d.js" as="script"><link rel="preload" href="/study/assets/js/2.da4bf759.js" as="script"><link rel="preload" href="/study/assets/js/1.32610913.js" as="script"><link rel="preload" href="/study/assets/js/12.5fdd5129.js" as="script"><link rel="prefetch" href="/study/assets/js/10.ab8221a0.js"><link rel="prefetch" href="/study/assets/js/11.113351b8.js"><link rel="prefetch" href="/study/assets/js/13.1603f2d3.js"><link rel="prefetch" href="/study/assets/js/14.05daf5c7.js"><link rel="prefetch" href="/study/assets/js/15.b8d51bfb.js"><link rel="prefetch" href="/study/assets/js/16.bd322f9d.js"><link rel="prefetch" href="/study/assets/js/17.efb722f5.js"><link rel="prefetch" href="/study/assets/js/18.e988ae10.js"><link rel="prefetch" href="/study/assets/js/19.f5512cb9.js"><link rel="prefetch" href="/study/assets/js/20.2278a2ee.js"><link rel="prefetch" href="/study/assets/js/21.6eeb7cf6.js"><link rel="prefetch" href="/study/assets/js/22.62e71d18.js"><link rel="prefetch" href="/study/assets/js/23.3c5ffb81.js"><link rel="prefetch" href="/study/assets/js/24.5fe3b430.js"><link rel="prefetch" href="/study/assets/js/25.80316ba3.js"><link rel="prefetch" href="/study/assets/js/26.a0e62d2f.js"><link rel="prefetch" href="/study/assets/js/27.80541f0e.js"><link rel="prefetch" href="/study/assets/js/28.8d04b116.js"><link rel="prefetch" href="/study/assets/js/29.4b5b48fc.js"><link rel="prefetch" href="/study/assets/js/3.34f32999.js"><link rel="prefetch" href="/study/assets/js/30.fa08dc18.js"><link rel="prefetch" href="/study/assets/js/31.ebf053ea.js"><link rel="prefetch" href="/study/assets/js/32.7894b6eb.js"><link rel="prefetch" href="/study/assets/js/33.90f5d121.js"><link rel="prefetch" href="/study/assets/js/34.b1a430df.js"><link rel="prefetch" href="/study/assets/js/35.eea84849.js"><link rel="prefetch" href="/study/assets/js/36.26e0e70d.js"><link rel="prefetch" href="/study/assets/js/4.6c9e285d.js"><link rel="prefetch" href="/study/assets/js/5.59f03725.js"><link rel="prefetch" href="/study/assets/js/6.42957e93.js"><link rel="prefetch" href="/study/assets/js/7.c81b5cba.js"><link rel="prefetch" href="/study/assets/js/vendors~docsearch.3818ef7a.js">
    <link rel="stylesheet" href="/study/assets/css/0.styles.7070726e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study/" class="home-link router-link-active"><img src="/study/logo.svg" alt="Study Notes" class="logo"> <span class="site-name can-hide">Study Notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/study/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/study/spring/" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/study/springboot/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/study/es/" class="nav-link">
  Elasticsearch
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="More" class="dropdown-title"><span class="title">More</span> <span class="arrow down"></span></button> <button type="button" aria-label="More" class="mobile-dropdown-title"><span class="title">More</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study/mybatis/" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/study/mybatisplus/" class="nav-link">
  MybatisPlus
</a></li><li class="dropdown-item"><!----> <a href="/study/springcloudgateway/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  SpringCloudGateway
</a></li><li class="dropdown-item"><!----> <a href="/study/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/study/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/study/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/study/nodejs/" class="nav-link">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/study/jvm/" class="nav-link">
  Jvm
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/study/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/study/spring/" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/study/springboot/" class="nav-link">
  SpringBoot
</a></div><div class="nav-item"><a href="/study/es/" class="nav-link">
  Elasticsearch
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="More" class="dropdown-title"><span class="title">More</span> <span class="arrow down"></span></button> <button type="button" aria-label="More" class="mobile-dropdown-title"><span class="title">More</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study/mybatis/" class="nav-link">
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/study/mybatisplus/" class="nav-link">
  MybatisPlus
</a></li><li class="dropdown-item"><!----> <a href="/study/springcloudgateway/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  SpringCloudGateway
</a></li><li class="dropdown-item"><!----> <a href="/study/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/study/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/study/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/study/nodejs/" class="nav-link">
  Nodejs
</a></li><li class="dropdown-item"><!----> <a href="/study/jvm/" class="nav-link">
  Jvm
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>GateWay</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study/springcloudgateway/#网关过滤器-gatewayfilter" class="sidebar-link">网关过滤器 GatewayFilter</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#path-路径过滤器" class="sidebar-link">Path 路径过滤器</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#parameter参数过滤器" class="sidebar-link">Parameter参数过滤器</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#status状态过滤器" class="sidebar-link">Status状态过滤器</a></li></ul></li><li><a href="/study/springcloudgateway/#全局过滤器-globalfilter" class="sidebar-link">全局过滤器 GlobalFilter</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/study/springcloudgateway/#自定义过滤器" class="sidebar-link">自定义过滤器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#自定义网关过滤器" class="sidebar-link">自定义网关过滤器</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#自定义全局过滤器" class="sidebar-link">自定义全局过滤器</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#统一鉴权" class="sidebar-link">统一鉴权</a></li></ul></li><li><a href="/study/springcloudgateway/#过滤器执行顺序" class="sidebar-link">过滤器执行顺序</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/study/springcloudgateway/#网关限流" class="sidebar-link">网关限流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#为什么需要限流" class="sidebar-link">为什么需要限流</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#限流算法" class="sidebar-link">限流算法</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#漏桶算法" class="sidebar-link">漏桶算法</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#令牌桶算法" class="sidebar-link">令牌桶算法</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#gateway限流" class="sidebar-link">Gateway限流</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#参数限流" class="sidebar-link">参数限流</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#ip限流" class="sidebar-link">IP限流</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#sentinel限流" class="sidebar-link">Sentinel限流</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#自定义异常信息" class="sidebar-link">自定义异常信息</a></li><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#分组限流" class="sidebar-link">分组限流</a></li></ul></li><li><a href="/study/springcloudgateway/#高可用网关" class="sidebar-link">高可用网关</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/springcloudgateway/#nginx-网关集群实现高可用网关" class="sidebar-link">Nginx + 网关集群实现高可用网关</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="gateway"><a href="#gateway" class="header-anchor">#</a> GateWay</h1> <h3 id="gateway是什么"><a href="#gateway是什么" class="header-anchor">#</a> GateWay是什么</h3> <blockquote><p>Spring Cloud Gateway是Spring官方基于Spring 5.0，Spring Boot 2.0和Project Reactor等技术开发的网关，Spring Cloud Gateway旨在为微服务架构提供一种简单而有效的统一的API路由管理方式。Spring Cloud Gateway作为Spring Cloud生态系中的网关，目标是替代ZUUL，其不仅提供统一的路由方式，并且基于Filter链的方式提供了网关基本的功能，例如：安全，监控/埋点，和限流等。</p></blockquote> <h3 id="为什么使用gateway"><a href="#为什么使用gateway" class="header-anchor">#</a> 为什么使用GateWay</h3> <blockquote><p>Spring Cloud Gateway 可以看做是一个 Zuul 1.x 的升级版和代替品，比 Zuul 2 更早的使用 Netty 实现异步 IO，从而实现了一个简单、比 Zuul 1.x 更高效的、与 Spring Cloud 紧密配合的 API 网关。</p></blockquote> <blockquote><p>Spring Cloud Gateway 里明确的区分了 Router 和 Filter，并且一个很大的特点是内置了非常多的开箱即用功能，并且都可以通过 SpringBoot 配置或者手工编码链式调用来使用。</p></blockquote> <blockquote><p>比如内置了 10 种 Router，使得我们可以直接配置一下就可以随心所欲的根据 Header、或者 Path、或者 Host、或者 Query 来做路由。
比如区分了一般的 Filter 和全局 Filter，内置了 20 种 Filter 和 9 种全局 Filter，也都可以直接用。当然自定义 Filter 也非常方便。</p></blockquote> <p><strong>概念</strong></p> <img src="/study/assets/img/image-20210701122415219.8d2c1e37.png" alt="image-20210701122415219" style="zoom:80%;"> <h3 id="什么是服务网关"><a href="#什么是服务网关" class="header-anchor">#</a> 什么是服务网关</h3> <p>API GateWay（APIGW/API 网关），顾名思义，是出现在系统边界上的一个面向API的、串行集中式的强管控服务，这里的边界是企业IT系统的边界，可以理解为<code>企业级应用防火墙</code>，主要起到<code>隔离外部访问与内部系统的作用</code>。在微服务概念流行之前，API网关就已经诞生了，例如银行、证券等领域常见的前置机系统，它也是解决访问认证、报文转换、访问统计等问题的。</p> <p>API网关的流行，源于近几年来移动应用与企业间互联网需求的兴起从以前单一的Web应用，扩展到多种使用场景，且每种使用场景对后台服务的要求不同，这不仅增加了后台服务的响应量，还增加了后台服务的复杂性。<code>随着微服务架构的概念提出，API网关成为了微服务的一个标配组件</code></p> <p>API网关是一个服务器，是系统对外的唯一入口。API网关封装了系统内部架构，为每个客户端提供定制API。所有的客户端和消费端都通过统一的网关接入微服务，在网关层处理所有非业务功能。API网关并不是微服务场景中必须的组件，不管有没有API网关，后端服务都可以通过API很好的支持客户端的访问。</p> <img src="/study/assets/img/image-20210701135628853.0bfc0f3e.png" alt="image-20210701135628853" style="zoom:80%;"> <p>​	但对于服务数量众多、复杂度比较高、规模比较大的业务来说，引入API网关也有一系列好处：</p> <ul><li>聚合接口使得服务对调用者透明，客户端与后端的耦合度降低</li> <li>聚合后台服务，节省流量，提高性能，提升用户体验</li> <li>提供安全、流控、过滤、缓存、计费、监控等API管理功能</li></ul> <h3 id="为什么要使用网关"><a href="#为什么要使用网关" class="header-anchor">#</a> 为什么要使用网关</h3> <ul><li>单体应用：浏览器发起请求到单体应用所在的机器，应用从数据库查询原路返回给浏览器，对于单体应用来说是不需要网关的</li> <li>微服务：微服务的应用可能部署在不同机器、不同地区、不同域名下。此时客户端（浏览器/手机/软件工具）想要请求对应的服务，都需要知道机器的具体IP或者域名URl，当微服务实例众多时，这是非常难以记忆的，对于客户端来说也是复杂难以维护的。此时就有了网关，客户端相关的请求直接发送到网关，由网关根据请求标识解析判断出具体的微服务地址，再把请求换发给微服务实例。这其中的记忆功能就全部交给网关来操作。</li></ul> <img src="/study/assets/img/image-20210701140816453.3280539a.png" alt="image-20210701140816453" style="zoom:80%;"> <p>总结：</p> <p>如果让客户端直接与各个微服务交互：</p> <ul><li>客户端会多次请求不同的微服务，增加了客户端的复杂性</li> <li>存在跨域请求，在一定场景下处理相对复杂</li> <li>身份认证问题，每个微服务需要独立身份认证</li> <li>难以重构，随着项目的迭代，可能需要重新划分微服务</li> <li>某些微服务可能使用了防火墙/浏览器不友好协议，直接访问会有问题</li></ul> <p>因此，我们需要网关介于客户端与服务器之间的中间层，所有外部请求率先经过微服务网关，客户端只需要与网关交互，只需要知道网关地址即可，简化了开发：</p> <ul><li>易于监控，可在微服务网关收集监控数据并将其推送到外部系统进行分析</li> <li>易于认证，可在微服务网关上进行认证，然后再将请求转发到后端的微服务，从而无需在每个微服务中进行认证</li> <li>减少了客户端与各个微服务之间的交互次数</li></ul> <h3 id="网关解决了什么问题"><a href="#网关解决了什么问题" class="header-anchor">#</a> 网关解决了什么问题</h3> <img src="/study/assets/img/image-20210701143436889.2a08bcfe.png" alt="image-20210701143436889" style="zoom:80%;"> <p>网关具有身份认证与安全、审查与监控、动态路由、负载均衡、缓存、请求分片与管理、静态响应处理等功能，最主要的职责就是与“外界联系”。</p> <p>网关应具备以下功能：</p> <ul><li>性能：API 高可用，负载均衡，容错机制</li> <li>安全：权限身份认证、脱敏、流量清洗、后端签名、黑名单</li> <li>日志：日志记录，一旦涉及分布式，全链路跟踪必不可少</li> <li>缓存：数据缓存</li> <li>监控：记录请求响应数据，API耗时分析，性能监控</li> <li>限流：流量控制，错峰流控，可以定义多种限流规则</li> <li>灰度：线上灰色部署，可以较少风险</li> <li>路由：动态路由规则</li></ul> <h3 id="常用网关解决方案"><a href="#常用网关解决方案" class="header-anchor">#</a> 常用网关解决方案</h3> <h3 id="_1、nginx-lua"><a href="#_1、nginx-lua" class="header-anchor">#</a> 1、Nginx + Lua</h3> <p>​	Nginx是由伊戈尔·赛索耶夫为<a href="https://baike.baidu.com/item/%E4%BF%84%E7%BD%97%E6%96%AF/125568" target="_blank" rel="noopener noreferrer">俄罗斯<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>访问量第二的Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004年10月4日。</p> <p>​	Nginx因它的稳定性、丰富的功能集、简单的配置文件和低系统资源的消耗而闻名。</p> <p>​	Nginx是一款<a href="https://baike.baidu.com/item/%E8%BD%BB%E9%87%8F%E7%BA%A7/10002835" target="_blank" rel="noopener noreferrer">轻量级<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的<a href="https://baike.baidu.com/item/Web/150564" target="_blank" rel="noopener noreferrer">Web<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 服务器/<a href="https://baike.baidu.com/item/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/7793488" target="_blank" rel="noopener noreferrer">反向代理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>服务器及<a href="https://baike.baidu.com/item/%E7%94%B5%E5%AD%90%E9%82%AE%E4%BB%B6/111106" target="_blank" rel="noopener noreferrer">电子邮件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（IMAP/POP3）代理服务器，在BSD-like 协议下发行。其特点是占有内存少，<a href="https://baike.baidu.com/item/%E5%B9%B6%E5%8F%91/11024806" target="_blank" rel="noopener noreferrer">并发<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>能力强，事实上nginx的并发能力在同类型的网页服务器中表现较好，中国大陆使用nginx网站用户有：百度、<a href="https://baike.baidu.com/item/%E4%BA%AC%E4%B8%9C/210931" target="_blank" rel="noopener noreferrer">京东<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://baike.baidu.com/item/%E6%96%B0%E6%B5%AA/125692" target="_blank" rel="noopener noreferrer">新浪<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://baike.baidu.com/item/%E7%BD%91%E6%98%93/185754" target="_blank" rel="noopener noreferrer">网易<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://baike.baidu.com/item/%E8%85%BE%E8%AE%AF/112204" target="_blank" rel="noopener noreferrer">腾讯<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://baike.baidu.com/item/%E6%B7%98%E5%AE%9D/145661" target="_blank" rel="noopener noreferrer">淘宝<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>等。</p> <p>​	Nginx一方面可以做反向代理，另一方面可以做静态资源服务器。</p> <blockquote><ul><li>Nginx适合做门户网关，是作为整个全局的网关，对外的处于最外层的那种；而GateWay属于业务网关吗，主要用来对应不同的客户端提供服务，用户聚合业务。各个微服务独立部署，职责单一，对外提供服务的时候需要有一个东西把业务聚合起来。</li> <li>GateWay可以实现熔断、重试等功能，这是Nginx不具备的。</li></ul></blockquote> <h3 id="_2、kong"><a href="#_2、kong" class="header-anchor">#</a> 2、Kong</h3> <p>​	Kong是Mashape提供的一款API管理软件，本身是基于Nginx + Lua 的，但比 Nginx 提供了更简单的配置方式，数据采用了ApacheCassandra/PostgreSQL存储，并且提供了一些优秀的插件，比如验证，日志，调用频次限制等。Kong非常诱人的地方就是提供了大量的插件来扩展应用，通过设置不同插件可以为服务提供各种增强的功能。</p> <blockquote><p>优点：基于Nginx所以在性能和稳定上都没有问题，Kong作为一款商业软件，在Nginx上做了很多的扩展工作，而且还有很多付费的商业插件。Kong本身也有付费的企业版，其中包括技术支持、使用培训服务以及API分析插件</p> <p>缺点：如果使用SpringCloud，Kong如何结合目前已有的服务治理体系</p></blockquote> <h3 id="_3、traefik"><a href="#_3、traefik" class="header-anchor">#</a> 3、Traefik</h3> <p>Traefik(https://traefik.io/)是一款开源的Go语言开发的反向代理与负载均衡工具。它最大的优点是能够与常见的微服务系统直接整合，可以实现自动化动态配置。目前支持Docker, Swarm, Mesos/Marathon, Mesos, Kubernetes, Consul, Etcd, Zookeeper, BoltDB, Rest API等等后端模型。Traefik拥有一个基于AngelarJS编写的简单网站界面，支持Rest API，配置文件热更新，无需重启进程，高可用集群模式等。</p> <blockquote><p>相对SpringCloud 和 Kubernetes 而言，目前比较适合 Kubernetes</p></blockquote> <h3 id="_4、spring-cloud-netflix-zuul"><a href="#_4、spring-cloud-netflix-zuul" class="header-anchor">#</a> 4、Spring Cloud Netflix Zuul</h3> <p>​	Zuul是Netflix公司开源的一个API网关组件，SpringCloud对其进行二次基于SpringBoot的注解式封装做到开箱即用。目前来说，结合 SpringCloud 提供的服务治理体系，可以做到请求转发，根据配置或者默认的路由规则进行路由和Load Balance，无缝集成 Hystrix</p> <blockquote><p>虽然可以通过自定义Filter实现我们想要的功能，但是由于Zuul本身设计是基于<code>单线程的接收请求和转发处理</code>，是阻塞IO，不支持长连接。目前来看Zuul就显得很鸡肋，随着Zuul2.x一直跳票（2019年5月发布了Zuul2.0版本），SpringCloud推出自己的SpringCloudGateWay</p></blockquote> <img src="/study/assets/img/image-20210701152222526.90fbafee.png" alt="image-20210701152222526" style="zoom:50%;"> <img src="/study/assets/img/image-20210701152327076.2bf9e1cb.png" alt="image-20210701152327076" style="zoom:50%;"> <h1 id="环境准备"><a href="#环境准备" class="header-anchor">#</a> 环境准备</h1> <ol><li>SpringBoot（2.1.6.RELEASE）</li> <li>SpringCloud（Greenwich.RELEASE）</li> <li>SpringCloudAlibaba（2.1.6.RELEASE）</li> <li>SoringCloudGateWay</li></ol> <p><img src="/study/assets/img/idea64_q9NcYh49nX.fb7254a7.png" alt="idea64_q9NcYh49nX"></p> <blockquote><p>父依赖</p></blockquote> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.boot.version</span><span class="token punctuation">&gt;</span></span>2.1.6.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.boot.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.cloud.version</span><span class="token punctuation">&gt;</span></span>Greenwich.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.cloud.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.cloud.alibaba</span><span class="token punctuation">&gt;</span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.cloud.alibaba</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lombok.version</span><span class="token punctuation">&gt;</span></span>1.18.20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lombok.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mysql.version</span><span class="token punctuation">&gt;</span></span>8.0.25<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mysql.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mybatis.version</span><span class="token punctuation">&gt;</span></span>2.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mybatis.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.cloud.feign</span><span class="token punctuation">&gt;</span></span>1.4.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.cloud.feign</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.boot.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.boot.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.cloud.alibaba}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${lombok.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${mysql.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.mybatis.spring.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${mybatis.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-feign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.cloud.feign}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>Spring Cloud Alibaba Nacos</p> <p>服务注册</p> <img src="/study/assets/img/image-20210701153502857.1341c5f0.png" alt="image-20210701153502857" style="zoom:80%;"> <h1 id="nginx实现api网关"><a href="#nginx实现api网关" class="header-anchor">#</a> Nginx实现API网关</h1> <img src="/study/assets/img/e7cd7b899e510fb30f2466c67079df95d143ad4ba602.726e2cb2.png" style="zoom:30%;"> <p><em>Nginx</em> (engine x) 是一个高性能的<a href="https://baike.baidu.com/item/HTTP" target="_blank" rel="noopener noreferrer">HTTP<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://baike.baidu.com/item/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/7793488" target="_blank" rel="noopener noreferrer">反向代理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>web服务器，同时也提供了IMAP/POP3/SMTP服务。Nginx是由伊戈尔·赛索耶夫为<a href="https://baike.baidu.com/item/%E4%BF%84%E7%BD%97%E6%96%AF/125568" target="_blank" rel="noopener noreferrer">俄罗斯<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>访问量第二的Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004年10月4日。</p> <blockquote><p>下载</p></blockquote> <p><a href="http://nginx.org/en/download.html" target="_blank" rel="noopener noreferrer">下载地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank" rel="noopener noreferrer">配置文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <img src="/study/assets/img/image-20210701154901563.7321744b.png" alt="image-20210701154901563" style="zoom:80%;"> <blockquote><p>默认端口80 有冲突在配置文件里修改</p></blockquote> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment"> # 端口</span>
<span class="token key attr-name">server</span> <span class="token value attr-value">{</span>
<span class="token comment">	# 默认是80 我改成了88 也可以不修改</span>
<span class="token key attr-name">    listen</span> <span class="token value attr-value">      8088;</span>
<span class="token key attr-name">    server_name</span> <span class="token value attr-value"> localhost;</span>

<span class="token key attr-name">    location</span> <span class="token value attr-value">/ {</span>
<span class="token key attr-name">    root</span> <span class="token value attr-value">  html;</span>
<span class="token key attr-name">    index</span> <span class="token value attr-value"> index.html index.htm;</span>
    }

<span class="token comment">	# 代理地址 输入localhost:8088/fuwu 就可以访问服务API</span>
<span class="token key attr-name">    location</span> <span class="token value attr-value">/fuwu {</span>
<span class="token key attr-name">    proxy_pass</span> <span class="token value attr-value">http://naihe:8001/product/list;</span>
    }

<span class="token key attr-name">    location</span> <span class="token value attr-value">/yonghu {</span>
<span class="token key attr-name">    proxy_pass</span> <span class="token value attr-value">http://naihe:8002/consumer/list;</span>
    }
<span class="token key attr-name">    error_page</span> <span class="token value attr-value">  500 502 503 504  /50x.html;</span>
<span class="token key attr-name">    location</span> <span class="token punctuation">=</span> <span class="token value attr-value">/50x.html {</span>
<span class="token key attr-name">    root</span> <span class="token value attr-value">  html;</span>
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>以前：http://localhost:8001/provider/list，http://localhost:8002/consumer/list</p> <p>现在：启动nginx，浏览器输入http://localhost:8088/fuwu, http://localhost:8088/yonghu</p> <img src="/study/assets/img/image-20210701155600484.3078f88d.png" alt="image-20210701155600484" style="zoom:80%;"> <h1 id="gateway实现api网关"><a href="#gateway实现api网关" class="header-anchor">#</a> GateWay实现API网关</h1> <p>官方文档：https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/</p> <blockquote><p>核心概念</p></blockquote> <p>​	**路由（Route）：**路由是网关最基础的部分，路由信息由ID、目标URI、断言和过滤器组成，如果断言路由为真，则说明请求的URI和配置匹配</p> <p>​	**断言（Predicate）：**java8中的断言函数，SpringCloudGateWay中的断言函数输入类型是Spring5.0框架中的ServerWebExchange。SpringCloudGateWay中的断言函数允许开发者去定义匹配来自于Http Request中的任何信息，比如请求头和参数等</p> <p>​	**过滤器（Filter）：**一个标准的SpringWebFilter，SpringCloudGateWay中的Filter分为两种类型，分别是Gateway Filter 和 Global Filter，过滤器将会对请求和响应进行处理</p> <blockquote><p>工作原理</p></blockquote> <img src="/study/assets/img/image-20210702083241038.f776c5b6.png" alt="image-20210702083241038" style="zoom:80%;"> <p>客户端向 Spring Cloud Gateway 发出请求。如果网关处理程序映射确定请求与路由匹配，则将其发送到网关 Web 处理程序。此处理程序通过特定于请求的过滤器链运行请求。过滤器被虚线分隔的原因是过滤器可以在发送代理请求之前和之后运行逻辑。执行所有“预”过滤器逻辑。然后进行代理请求。发出代理请求后，将运行“post”过滤器逻辑。</p> <p><em>在没有端口的路由中定义的 URI 分别获得 HTTP 和 HTTPS URI 的默认端口值 80 和 443。</em></p> <blockquote><p>搭建网关服务</p></blockquote> <blockquote><p>创建cloud.gateway项目</p></blockquote> <blockquote><p>导入依赖</p></blockquote> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- gateway --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- nacos --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>启动类</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>配置文件 yml</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud.gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
        <span class="token comment"># 是否与服务发现进行结合，通过servierid转发具体服务实例</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>           <span class="token comment"># 是否开启基于服务发现的路由规则</span>
        <span class="token key atrule">lower-case-service-id</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token comment"># 是否将服务名称转小写</span>

      <span class="token comment"># 路由规则</span>
      <span class="token comment"># routes:</span>
        <span class="token comment"># - id: gateway-consumer              # 路由 ID</span>
          <span class="token comment"># uri: lb://cloud.consumer       # 目标 URI 从注册中心拿取服务名 lb 是负载均衡 前提把gateway注册到nacos</span>
          <span class="token comment"># predicates:                       # 断言（判断条件）</span>
            <span class="token comment"># - Path=/consumer/**           # 匹配对应的 URL 请求 将匹配到的请求追加到目标 URI 之后</span>
            <span class="token comment"># - Query=naihe, 666.           # 请求参数中必须包含 naihe，并且参数值必须满足正则表达式 . 意思就是666后必须还有一个参数值 ：6667、6668</span>
            <span class="token comment"># - Method=GET                  # 匹配请求类型</span>
            <span class="token comment"># - After=2021-05-01T20:20:20.000+08:00[Asia/Shanghai] # 匹配某段时间之后的请求</span>
            <span class="token comment"># - Before=2021-07-01T20:20:20.000+08:00[Asia/Shanghai] # 匹配某段时间之前的请求</span>
            <span class="token comment"># - RemoteAddr=192.168.0.48/0     # 匹配远程地址请求是 RemoteAddr 的请求 0表示子网掩码 这是localhost请求已经访问不到了</span>
            <span class="token comment"># - Header=NH-naihe, \d+          # 请求必须包含请求头 NH-naihe，并且内容为数字</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h1 id="路由规则"><a href="#路由规则" class="header-anchor">#</a> 路由规则</h1> <blockquote><p>详解</p></blockquote> <blockquote><p>-Path</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer              <span class="token comment"># 路由 ID</span>
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8002/     <span class="token comment"># 目标 URI 路由到微服务地址</span>
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                       <span class="token comment"># 断言（判断条件）</span>
        	<span class="token punctuation">-</span> Path=/consumer/<span class="token important">**</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><img src="/study/assets/img/image-20210702084936987.368be591.png" alt="image-20210702084936987" style="zoom:80%;"> <blockquote><p>-Query</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer              <span class="token comment"># 路由 ID</span>
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8002/     <span class="token comment"># 目标 URI 路由到微服务地址</span>
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                     <span class="token comment"># 断言（判断条件）</span>
        	<span class="token punctuation">-</span> Query=naihe<span class="token punctuation">,</span> <span class="token number">666.</span>         <span class="token comment"># 请求参数中必须包含 naihe，并且参数值必须满足正则表达式 . 意思就是666后必须还有一个参数值 ：6667、6668</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><img src="/study/assets/img/image-20210702085240645.7b80fcda.png" alt="image-20210702085240645" style="zoom:80%;"> <blockquote><p>-Method</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer              <span class="token comment"># 路由 ID</span>
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8002/     <span class="token comment"># 目标 URI 路由到微服务地址</span>
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                     <span class="token comment"># 断言（判断条件）</span>
        	<span class="token punctuation">-</span> Method=GET                <span class="token comment"># 匹配请求类型</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><img src="/study/assets/img/1625187593400.fc64d415.png" alt="1625187593400" style="zoom:67%;"> <img src="/study/assets/img/1625187748148.35d98343.png" alt="1625187748148" style="zoom:67%;"> <p><em>结论：</em></p> <p>​		设置- Method=GET 后 get请求可以路由 post请求无法路由</p> <blockquote><p>-After</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer              <span class="token comment"># 路由 ID</span>
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8002/     <span class="token comment"># 目标 URI 路由到微服务地址</span>
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                     <span class="token comment"># 断言（判断条件）</span>
        	<span class="token punctuation">-</span> After=2021<span class="token punctuation">-</span>05<span class="token punctuation">-</span>01T20<span class="token punctuation">:</span>20<span class="token punctuation">:</span>20.000+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span> <span class="token comment"># 匹配某段时间之后的请求</span>
        	<span class="token punctuation">-</span> Before=2021<span class="token punctuation">-</span>05<span class="token punctuation">-</span>01T20<span class="token punctuation">:</span>20<span class="token punctuation">:</span>20.000+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span> <span class="token comment"># 匹配某段时间之前的请求</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><img src="/study/assets/img/image-20210702090622887.d1fc7f1b.png" alt="image-20210702090622887" style="zoom:67%;"> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer              <span class="token comment"># 路由 ID</span>
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8002/     <span class="token comment"># 目标 URI 路由到微服务地址</span>
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                     <span class="token comment"># 断言（判断条件）</span>
        	<span class="token punctuation">-</span> After=2021<span class="token punctuation">-</span>08<span class="token punctuation">-</span>01T20<span class="token punctuation">:</span>20<span class="token punctuation">:</span>20.000+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span> <span class="token comment"># 匹配某段时间之后的请求</span>
        	<span class="token comment"># 将条件修改为 八月一日之后 路由不到</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><img src="/study/assets/img/image-20210702090838293.e18d4d9d.png" alt="image-20210702090838293" style="zoom:67%;"> <blockquote><p>-RemoteAddr</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer              <span class="token comment"># 路由 ID</span>
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8002/     <span class="token comment"># 目标 URI 路由到微服务地址</span>
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                     <span class="token comment"># 断言（判断条件）</span>
        	<span class="token punctuation">-</span> RemoteAddr=192.168.0.48/0     <span class="token comment"># 匹配远程地址请求是 RemoteAddr 的请求 0表示子网掩码 这是localhost请求已经访问不到了</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><img src="/study/assets/img/image-20210702091148721.539d4cd0.png" alt="image-20210702091148721" style="zoom:67%;"> <img src="/study/assets/img/image-20210702091225522.a928c78e.png" alt="image-20210702091225522" style="zoom:67%;"> <blockquote><p>-Header</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer              <span class="token comment"># 路由 ID</span>
        <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8002/     <span class="token comment"># 目标 URI 路由到微服务地址</span>
        <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                     <span class="token comment"># 断言（判断条件）</span>
        	<span class="token punctuation">-</span> Header=NH<span class="token punctuation">-</span>naihe<span class="token punctuation">,</span> \d+          <span class="token comment"># 请求必须包含请求头 NH-naihe，并且内容必须为数字</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><img src="/study/assets/img/image-20210702091504157.94fcef65.png" alt="image-20210702091504157" style="zoom:67%;"> <img src="/study/assets/img/image-20210702091554290.31e83979.png" alt="image-20210702091554290" style="zoom:67%;"> <h1 id="动态路由"><a href="#动态路由" class="header-anchor">#</a> 动态路由</h1> <blockquote><p>服务发现的路由规则</p></blockquote> <p>​	动态路由其实就是面向服务的路由，SpringCloudGateway 支持与Eureka、nacos整合开发，根据serviceId自动从注册中心获取服务地址并转发请求，这样做的好处就是不仅可以通过单个端点来访问应用的所有服务，而且在添加移除服务时不用修改Gateway的路由配置</p> <blockquote><p>动态获取URL</p></blockquote> <blockquote><p>配置文件</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer              <span class="token comment"># 路由 ID</span>
    	<span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.consumer       <span class="token comment"># 目标 URI 从注册中心拿取服务名 lb 是负载均衡 前提把gateway注册到nacos</span>
    	<span class="token key atrule">predicates</span><span class="token punctuation">:</span>                       <span class="token comment"># 断言（判断条件）</span>
    		<span class="token punctuation">-</span> Path=/consumer/<span class="token important">**</span>           <span class="token comment"># 匹配对应的 URL 请求 将匹配到的请求追加到目标 URI 之后</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>​		http://localhost:9000/consumer/list</p> <img src="/study/assets/img/image-20210702094727385.8471edfc.png" alt="image-20210702094727385" style="zoom:67%;"> <p>但有一个问题，这种路由方式只能路由consumer 无法路由provider</p> <img src="/study/assets/img/image-20210702094920534.8ad2e119.png" alt="image-20210702094920534" style="zoom:67%;"> <p>解决办法：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer              <span class="token comment"># 路由 ID，唯一</span>
    	<span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.consumer       <span class="token comment"># 目标 URI 从注册中心拿取服务名 lb 是负载均衡 前提把gateway注册到nacos</span>
    	<span class="token key atrule">predicates</span><span class="token punctuation">:</span>                       <span class="token comment"># 断言（判断条件）</span>
    		<span class="token punctuation">-</span> Path=/consumer/<span class="token important">**</span>           <span class="token comment"># 匹配对应的 URL 请求 将匹配到的请求追加到目标 URI 之后</span>
    <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>provider              <span class="token comment"># 路由 ID，唯一</span>
    	<span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.provider       <span class="token comment"># 目标 URI 从注册中心拿取服务名 lb 是负载均衡 前提把gateway注册到nacos</span>
    	<span class="token key atrule">predicates</span><span class="token punctuation">:</span>                       <span class="token comment"># 断言（判断条件）</span>
    		<span class="token punctuation">-</span> Path=/product/<span class="token important">**</span>           <span class="token comment"># 匹配对应的 URL 请求 将匹配到的请求追加到目标 URI 之后</span>

   <span class="token comment"># 以此类推 如果有上百个服务 是不是就得配置上百个路由规则</span>
   <span class="token comment"># 复杂，不好维护</span>
   <span class="token comment"># 这个方法不可取</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>路由与服务发现进行结合，通过serviceId转发具体服务实例</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token comment"># 是否与服务发现组件进行结合，通过serviceId转发到具体微服务实例</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>                 <span class="token comment"># 是否开启基于服务发现的路由规则</span>
          <span class="token key atrule">lower-case-service-id</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token comment"># 是否将服务名称转小写</span>

          <span class="token comment"># 注意空格，不然路由不到o(╥﹏╥)o（栽过坑）</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>浏览器访问：http://localhost:9000/cloud.consumer/consumer/list，http://localhost:9000/cloud.provider/product/list</p> <img src="/study/assets/img/image-20210702100225547.1260215e.png" alt="image-20210702100225547" style="zoom:67%;"> <img src="/study/assets/img/image-20210702100324154.c4b2074d.png" alt="image-20210702100324154" style="zoom:67%;"> <h1 id="过滤器"><a href="#过滤器" class="header-anchor">#</a> 过滤器</h1> <p>SpringCloudGateway 根据作用范围划分为 <em>GatewayFilter</em> 和 <em>GlobalFilter</em> ，二者区别如下：</p> <ul><li>*GatewayFilter：*网关过滤器，需要通过 <em>spring.cloud.routes.filters</em> 配置在具体路由下，只作用在当前路由上或通过 <em>spring.cloud.default-filters</em>配置在全局，作用在所有路由上</li> <li>*GlobalFilter：*全局过滤器，不需要在配置文件中配置，作用在所有路由上，最终通过 <em>GatewayFilterAdapter</em> 包装成 <em>GatewayFilterChain</em> 可识别的过滤器，它为请求业务以及路由的URL转换为真实业务服务请求地址的核心过滤器，不需要配置系统初始化时的加载，并作用在每个路由上</li></ul> <h2 id="网关过滤器-gatewayfilter"><a href="#网关过滤器-gatewayfilter" class="header-anchor">#</a> 网关过滤器 GatewayFilter</h2> <p>​	网关过滤器用于拦截并链式处理Web请求，可以实现横切与应用无关的需求，比如：安全、访问超时的设置等。修改传入的HTTP请求或传出的HTTP响应，SpringCloudGateway包含许多内置的网关过滤器工厂，一共有22个，包含头部过滤器、路径类过滤器、Hystrix过滤器和重写请求URL的过滤器，还有参数和状态码等其他类型的过滤器。根据过滤器工厂用途来划分，可以分为以下几种：Header、Parameter、Path、Body、Status、Session、Redirect、Retry、RateLimiter和Hystrix</p> <img src="/study/assets/img/20181202154250869.5b8ce33a.png" style="zoom:50%;"> <blockquote><p>内置的过滤器工厂一共有22个，分别位于</p> <p>org.springframework.cloud.gateway.filter.factory</p> <p>及</p> <p>org.springframework.cloud.gateway.filter.factory.rewrite包中</p></blockquote> <img src="/study/assets/img/image-20210702105941961.0acc77d0.png" alt="image-20210702105941961" style="zoom:80%;"> <h3 id="path-路径过滤器"><a href="#path-路径过滤器" class="header-anchor">#</a> Path 路径过滤器</h3> <p>Path路径过滤器可以实现URL重写，通过重写URL可以实现隐藏实际路径提高安全性，易于用户记忆和键入，易于被搜索引擎收录等优点</p> <blockquote><p>RewritePathGatewayFilterFactory</p></blockquote> <p>​	RewritePath 网关过滤器工厂采用路径正则表达式参数和替换参数，使用Java正则表达式来灵活地重写请求路径</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud.gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.consumer
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
          	<span class="token comment"># 匹配对应的URI请求，将匹配到的请求追加在目标URI之后</span>
            <span class="token punctuation">-</span> Path=/consumer/<span class="token important">**</span><span class="token punctuation">,</span> /api<span class="token punctuation">-</span>gateway/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>	<span class="token comment"># 网关过滤器</span>
          	<span class="token comment"># 将 /api-gateway/consumer/list	重写为 /consumer/list</span>
            <span class="token punctuation">-</span> RewritePath=/api<span class="token punctuation">-</span>gateway(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">&gt;</span>/<span class="token punctuation">?</span>.<span class="token important">*)</span><span class="token punctuation">,</span> $\<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><blockquote><p>PrefixPathGatewayFilterFactory</p></blockquote> <p>​	PrefixPath网关过滤器工厂为匹配的URI添加指定前缀</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud.gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.consumer
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
          	<span class="token comment"># 将 /consumer 重写为 /consumer/list</span>
            <span class="token punctuation">-</span> PrefixPath=/consumer
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>浏览器输入：http://localhost:9000/list  --&gt; http://localhost:9000/consumer/list</p> <blockquote><p>StripPrefixGatewayFilterFactory</p></blockquote> <p>​	StripPrefix网关过滤器工厂采用一个参数 StripPrefix，该参数表示在将请求发送到下游之前从请求中剥离的路径个数</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud.gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.consumer
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
          	<span class="token comment"># 将/list 重写为 /consumer/list</span>
            <span class="token punctuation">-</span> StripPrefix=1
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>浏览器输入：http://localhost:9000/list/consumer/list --&gt; http://localhost:9000/consumer/list</p> <p>当访问 http://localhost:9000/list/consumer/list 时 系统会自动将这个路径的前一个URL去掉 /list</p> <p>当我们访问：http://localhost:9000/list/naihe/consumer/list 时 会发现 页面404</p> <p>这时只需要修改路由规则 - StripPrefix=2 即可	剥离数为2个	以此类推</p> <blockquote><p>SetPathGatewayFilterFactory</p></blockquote> <p>​	SetPath网关过滤器采用路径模板参数，它提供了一种通过允许模板化路径段来操作请求路径的简单方法，使用了SpringFramework中的uri模板，允许多个匹配段</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud.gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.consumer
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/api/consumer/<span class="token punctuation">{</span>segment<span class="token punctuation">}</span> <span class="token comment"># 也可以写多个匹配段 - Path=/api/consumer/{segment}, /naihe/list/{segment}</span>
            							<span class="token comment"># 不管写成什么，最后都会被设置为 /consumer/{segment}</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
          	<span class="token comment"># 会将 /api/consumer/list 重写为 /consumer/list</span>
            <span class="token punctuation">-</span> SetPath=/consumer/<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>会将 http://localhost:9000/api/consumer/list 设置为 http://localhost:9000/consumer/list</p> <blockquote><p>错误</p></blockquote> <p><strong>Map has no value for 'segment'</strong></p> <p>如果在访问时 浏览器出现这个错误 说明匹配规则没有{segment}段</p> <p>在- Path 后追加 {segment} 即可</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">predicates</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> Path=/<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
<span class="token key atrule">filters</span><span class="token punctuation">:</span>
	<span class="token punctuation">-</span> SetPath=/consumer/<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>http://localhost:9000/list 	---&gt;	http://localhost:9000/consumer/list</p> <h3 id="parameter参数过滤器"><a href="#parameter参数过滤器" class="header-anchor">#</a> Parameter参数过滤器</h3> <p>AddRequestParameter网关过滤器工厂会将指定参数添加至匹配到的下游请求中</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud.gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.consumer
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token comment">#- RewritePath=/api-gateway(?&lt;segment&gt;/?.*), $\{segment}</span>
            <span class="token comment">#- PrefixPath=/consumer</span>
            <span class="token comment">#- StripPrefix=2</span>
            <span class="token punctuation">-</span> SetPath=/consumer/<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
            <span class="token comment"># 在下游请求中添加参数flag=naihe</span>
            <span class="token punctuation">-</span> AddRequestParameter=flag<span class="token punctuation">,</span> naihe <span class="token comment"># filters 支持组合使用</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>修改consumer控制层代码</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ProductService</span> productService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">String</span> flag<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 添加 flag 方便查看效果</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;》》》客户端查询《《《&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;flag=&quot;</span><span class="token operator">+</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印 flag</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>productService<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>访问：http://localhost:9000/list</p> <img src="/study/assets/img/image-20210702121733181.c6e7c791.png" alt="image-20210702121733181"> <h3 id="status状态过滤器"><a href="#status状态过滤器" class="header-anchor">#</a> Status状态过滤器</h3> <p>SetStatus网关过滤器工厂采用单个状态参数，它必须是有效的Spring HttpStatus，可以是整数404、200/500或枚举NOT_FOUND等字符串表示</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud.gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>consumer
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.consumer
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> SetPath=/consumer/<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
            <span class="token punctuation">-</span> AddRequestParameter=flag<span class="token punctuation">,</span> naihe
            <span class="token comment"># 任何情况下，响应的HTTP状态码都将设置为 404</span>
            <span class="token punctuation">-</span> SetStatus=404
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>数据是正常显示的，只不过状态码变成了404而已</p> <img src="data:image/png;base64,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" alt="image-20210702122647672" style="zoom:80%;"> <h2 id="全局过滤器-globalfilter"><a href="#全局过滤器-globalfilter" class="header-anchor">#</a> 全局过滤器 GlobalFilter</h2> <p>全局过滤器不需要在配置文件中配置，作用在所有路由上，最终通过 GatewayFilterAdapter包装成 GatewayFIlterChain可识别的过滤器，它是请求业务以及路由的URI转换为真实业务服务请求地址的核心过滤器，不需要配置系统初始化加载，并作用在每个路由上</p> <img src="/study/assets/img/image-20210702123204186.ea0d04a2.png" alt="image-20210702123204186" style="zoom:80%;"> <h2 id="自定义过滤器"><a href="#自定义过滤器" class="header-anchor">#</a> 自定义过滤器</h2> <h3 id="自定义网关过滤器"><a href="#自定义网关过滤器" class="header-anchor">#</a> 自定义网关过滤器</h3> <p>自定义网关过滤器需要实现以下两个接口：GatewayFilter，Ordered</p> <blockquote><p>创建过滤器</p></blockquote> <p>​	实现 GatewayFilter, Ordered 接口</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomGatewayFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GatewayFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;自定义过滤器被执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 继续向下执行 */</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 过滤器执行顺序，数值越小，优先级越高
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><blockquote><p>注册过滤器</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span> <span class="token comment">// 标识配置类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayRoutesConfiguration</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">routeLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r
                <span class="token comment">// 断言（判断条件）</span>
                <span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/**&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// 目标 URI，路由到微服务的地址</span>
                <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;lb://cloud.consumer&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// 注册自定义网关过滤器</span>
                <span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomGatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 自己写的过滤器类</span>
                <span class="token comment">// 路由ID，唯一</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;gateway-consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="自定义全局过滤器"><a href="#自定义全局过滤器" class="header-anchor">#</a> 自定义全局过滤器</h3> <p>实现GatewayFilter，Ordered接口，通过全局过滤器可以实现权限校验，安全性验证等功能</p> <blockquote><p>创建过滤器</p></blockquote> <p>实现指定接口，添加@Component 注解</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;自定义全局过滤器被执行&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 通过打印信息查看是否生效</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="统一鉴权"><a href="#统一鉴权" class="header-anchor">#</a> 统一鉴权</h3> <p>在网关过滤器中通过token判断用户是否登录，完成一个统一鉴权案例</p> <blockquote><p>创建过滤器</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>naihe<span class="token punctuation">.</span>filter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GatewayFilterChain</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GlobalFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Ordered</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span></span><span class="token class-name">DataBuffer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span></span><span class="token class-name">ServerHttpResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerWebExchange</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @ProjectName SpringCloud_GateWay
 * @ClassName AccessFilter
 * @Author NAIHE
 * @Date 2021-07-02
 * @Week 周五
 * @Time 下午 02:53
 */</span>

<span class="token comment">/**
 * 权限验证过滤器
 * @author NAIHE
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccessFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取请求参数</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;token is null...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 响应类型</span>
            response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;application/json; charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 响应状态码 404表示用户没有权限访问</span>
            response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 响应内容</span>
            <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token string">&quot;{\&quot;message\&quot;:\&quot;&quot;</span><span class="token operator">+</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">.</span><span class="token function">getReasonPhrase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\&quot;}&quot;</span><span class="token punctuation">;</span>
            <span class="token comment">// 通过 DataBuffer 写出</span>
            <span class="token class-name">DataBuffer</span> buffer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;token is OK!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>不带token访问</p> <img src="/study/assets/img/image-20210702151043277.01229464.png" alt="image-20210702151043277" style="zoom:80%;"> <p>带token访问</p> <img src="/study/assets/img/image-20210702151138205.72dc5ae6.png" alt="image-20210702151138205" style="zoom:67%;"> <h2 id="过滤器执行顺序"><a href="#过滤器执行顺序" class="header-anchor">#</a> 过滤器执行顺序</h2> <blockquote><p>默认过滤器、自定义过滤器、全局过滤器优先级</p></blockquote> <p>全局过滤器与其他两类过滤器相比，永远是最后执行的；它的优先级只对其他全局过滤器起作用</p> <p>当默认过滤器与自定义过滤器的优先级一样时，优先出发默认过滤器，然后才是自定义过滤器；同类型的过滤器，出发顺序与他们在配置文件中声明的顺序一致</p> <p>默认过滤器与自定义过滤器使用同样的order顺序空间，即他们会按照各自的顺序来进行排序</p> <h2 id="网关限流"><a href="#网关限流" class="header-anchor">#</a> 网关限流</h2> <p>限流就是限制流量，比如你有20G流量包，用完就没了，通过限流我们可以很好地控制系统的QPS，从而达到保护系统的目的</p> <p><strong>QPS</strong>：<em>query per second,即每秒访问量。qps很大程度上代表了系统的繁忙度，没次请求可能存在多次的磁盘io，网络请求，多个cpu时间片，一旦qps超过了预先设置的阀值，可以考量扩容增加服务器，避免访问量过大导致的宕机。</em></p> <h3 id="为什么需要限流"><a href="#为什么需要限流" class="header-anchor">#</a> 为什么需要限流</h3> <p>“因为该软件所在的服务器容量有限,为了防止服务器阻塞,必须对访问用户限流”</p> <p>例：Web服务，对外API，这种类型的服务有以下可能导致机器被拖垮</p> <ul><li>用户增长过快</li> <li>某个热点事件（微博热搜。。。）</li> <li>爬虫</li> <li>恶意的请求</li></ul> <p>这些情况都是无法预知的，不知道什么时候就会有10倍、20倍的流量进来，遇到这种情况，扩容是根本来不及的</p> <img src="/study/assets/img/image-20210702152814520.13ced4a0.png" alt="image-20210702152814520" style="zoom:80%;"> <p>从上图可以看出，对内而言：上游的A、B服务直接依赖了下游的基础服务C，对于A、B服务都依赖的基础服务C 这种场景，服务A和B处于某种竞争关系，如果服务A的并发阈值过大，当流量高峰期来临，有可能直接拖垮基础服务C并影响服务B，即雪崩效应。</p> <h3 id="限流算法"><a href="#限流算法" class="header-anchor">#</a> 限流算法</h3> <blockquote><p>常见的限流算法</p></blockquote> <ul><li>计数器算法</li> <li>漏桶算法（Leaky Bucket）</li> <li>令牌桶算法（Token Bucket）</li></ul> <blockquote><p>计数器算法</p></blockquote> <p>计数器算法是最简单容易实现的一种算法</p> <p>例：规定A接口一分钟访问次数不能超过一百个，那我们可以在一开始的时候设置一个计时器counter，每当一个请求过来的时候，counter就加一，</p> <p>如果counter的值大于100并且该请求与第一个请求间隔时间在一分钟之内，就触发限流；如果该请求与第一个请求间隔时间超过一分钟，counter就重新计数</p> <img src="/study/assets/img/image-20210702154029291.efb974dd.png" alt="image-20210702154029291" style="zoom:80%;"> <p>这个算法虽然简单，但有一个致命问题，临界问题</p> <img src="/study/assets/img/image-20210702154212894.76bc7b53.png" alt="image-20210702154212894" style="zoom:80%;"> <p>假设有一个恶意用户，它在0:59时，瞬间发送了100个请求，并且在1:00的时候又瞬间发送了100个请求，实际上这个用户在1秒时间内发送了200个请求，和我们规定的一分钟内100请求有冲突，瞬间超过我们的速率限制，用户有可能通过这个算法的漏洞，瞬间压垮我们的应用</p> <p>还有资源浪费的问题存在，我们的预期想法是希望100个请求可以均匀分散在这一分钟内，假设30s以内我们就请求上限了，那么剩余的半分钟服务器就会处于闲置状态</p> <img src="/study/assets/img/image-20210702154857179.6f5f5251.png" alt="image-20210702154857179" style="zoom:80%;"> <h3 id="漏桶算法"><a href="#漏桶算法" class="header-anchor">#</a> 漏桶算法</h3> <p>楼桶算法可以粗略的认为就是注水漏水的过程，往桶中以任意速率流入水，以一定速率流出水，当水超过桶流量则丢弃，桶容量是不变的，保证了整体的速率</p> <img src="/study/assets/img/image-20210707101220303.8b6f8341.png" alt="image-20210707101220303" style="zoom:80%;"> <p>漏铜算法是通过队列机制实现的</p> <h3 id="令牌桶算法"><a href="#令牌桶算法" class="header-anchor">#</a> 令牌桶算法</h3> <p>​	令牌桶算法是对漏铜算法的一种改进，漏桶算法能够限制请求调用的速率，而令牌桶算法能够在限制调用的平均速率的同时还允许一定程度的突发调用，在令牌桶算法中，存在一个桶，用来存放一定数量的令牌。算法中存在一种机制，以一定机制向桶中放令牌，每次<code>请求调用需要先获取令牌</code>，只有<code>拿到令牌</code>才会<code>继续执行</code>，否则会选择等待可用令牌、或者直接拒绝，放令牌是持续不断进行的，如果桶中令牌数达到上限，则会丢弃令牌</p> <blockquote><p>场景：桶中一直有大量的可用令牌，这时进来的请求可以直接拿到令牌执行，比如设置QPS为100/s，那么限流器初始化完成一秒后，桶中就已经有100个令牌了，等服务启动完成对外提供服务时，该限流器可以抵挡瞬时的100个请求。当桶中没有令牌时，请求会进行等待，最后相当于以一定速率执行</p></blockquote> <p>Gateway内部算法：</p> <ul><li>所有的请求在处理之前都需要拿到一个可用的令牌才会被处理</li> <li>根据限流大小，设置按照一定的速率往桶里添加令牌</li> <li>桶设置最大的放置令牌限制，当桶满时，新添加的令牌会被抛弃或直接拒绝</li> <li>请求到达后首先要获取令牌桶中的令牌，拿着令牌才可以进行其他业务逻辑，处理完业务后，将令牌直接删除</li> <li>令牌有最低限额，当桶中的令牌达到最低限额后，请求处理完之后不会删除令牌，以此来保证足够的限流</li></ul> <img src="/study/assets/img/image-20210707110708261.097f6423.png" alt="image-20210707110708261" style="zoom:80%;"> <h3 id="gateway限流"><a href="#gateway限流" class="header-anchor">#</a> Gateway限流</h3> <p>​	官方提供了 <code>RequestRateLimiterGatewayFilterFactory</code> 过滤器工厂，使用<code>Redis</code>和<code>Lua</code>脚本实现了令牌桶方式</p> <p>​	官方文档：https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-redis-ratelimiter</p> <p>​	具体逻辑实现在<code>RequestRateLimiterGatewayFilterFactory</code>中，<code>Lua</code> 脚本在下图位置</p> <img src="/study/assets/img/image-20210707114054604.c2eb9f03.png" alt="image-20210707114054604" style="zoom:80%;"> <blockquote><p>添加依赖</p></blockquote> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!-- spring data redis reactive 依赖 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis-reactive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- commons-pool2 对象连接池 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>yaml配置</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud.gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment"># 路由规则</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>service                              <span class="token comment"># 路由ID 唯一</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.service                          <span class="token comment"># 根据服务名称从注册中心获取服务请求地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                                      <span class="token comment"># 断言</span>
            <span class="token punctuation">-</span> Path=/consumer/<span class="token important">**</span>                            <span class="token comment"># 匹配对应的URI请求 将匹配的请求追加到目标URI之后</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>                                         <span class="token comment"># 网关过滤器</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter                     <span class="token comment"># 限流过滤器</span>
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token comment"># 令牌桶每秒填充速率</span>
                <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">2</span>        <span class="token comment"># 令牌桶总容量</span>
                <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">&quot;#{@pathKeyResolver}&quot;</span>        <span class="token comment"># 使用 SpringEL 表达式按名称引用bean</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
  <span class="token comment"># redis 缓存</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>              <span class="token comment"># 连接超时时间</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost             <span class="token comment"># Redis服务器地址</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>                  <span class="token comment"># Redis服务器端口</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>                 <span class="token comment"># 选择哪一个库 默认0</span>
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">1024</span>        <span class="token comment"># 最大连接数 默认8</span>
        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">10000</span>         <span class="token comment"># 最大连接阻塞等待时间 单位毫秒 默认-1</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">200</span>           <span class="token comment"># 最大空闲连接 默认8</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">5</span>             <span class="token comment"># 最小空闲连接数 默认0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><blockquote><p>配置类</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>naihe<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>ratelimit<span class="token punctuation">.</span></span><span class="token class-name">KeyResolver</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @ProjectName SpringCloud_GateWay
 * @ClassName KeyResolverConfiguration
 * @Author NAIHE
 * @Date 2021-07-07
 * @Week 周三
 * @Time 下午 12:06
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KeyResolverConfiguration</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 限流规则
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">pathKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">// 与yml配置里名字一致</span>
        <span class="token comment">/*return new KeyResolver() {
            @Override
            public Mono&lt;String&gt; resolve(ServerWebExchange exchange) {
                return Mono.just(exchange.getRequest().getURI().getPath().toString());
            }
        }*/</span>
        <span class="token comment">// Lambda 表达式</span>
        <span class="token keyword">return</span> exchange <span class="token operator">-&gt;</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>启动服务，访问http://localhost:9000/consumer/list?token=123</p> <p>单次访问正常，增加qps，网页无法正常运作</p> <img src="/study/assets/img/image-20210707140421317.89b954c7.png" alt="image-20210707140421317" style="zoom:80%;"> <h3 id="参数限流"><a href="#参数限流" class="header-anchor">#</a> 参数限流</h3> <blockquote><p>配置类</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 根据参数限流
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">parameterKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">KeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;携带参数：&quot;</span><span class="token operator">+</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;参数为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><blockquote><p>yaml配置</p></blockquote> <p>将<code>key-resolver</code>值改为限流方法名</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud.gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment"># 路由规则</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>service                              <span class="token comment"># 路由ID 唯一</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.consumer                          <span class="token comment"># 根据服务名称从注册中心获取服务请求地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                                      <span class="token comment"># 断言</span>
            <span class="token punctuation">-</span> Path=/consumer/<span class="token important">**</span>                            <span class="token comment"># 匹配对应的URI请求 将匹配的请求追加到目标URI之后</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>                                         <span class="token comment"># 网关过滤器</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter                     <span class="token comment"># 限流过滤器</span>
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token comment"># 令牌桶每秒填充速率</span>
                <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">2</span>        <span class="token comment"># 令牌桶总容量</span>
                <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">&quot;#{@parameterKeyResolver}&quot;</span>        <span class="token comment"># 使用 SpEL 表达式按名称引用bean</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
  <span class="token comment"># redis 缓存</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>              <span class="token comment"># 连接超时时间</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1             <span class="token comment"># Redis服务器地址</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>                  <span class="token comment"># Redis服务器端口</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>                 <span class="token comment"># 选择哪一个库 默认0</span>
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">1024</span>        <span class="token comment"># 最大连接数 默认8</span>
        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">10000</span>         <span class="token comment"># 最大连接阻塞等待时间 单位毫秒 默认-1</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">200</span>           <span class="token comment"># 最大空闲连接 默认8</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">5</span>             <span class="token comment"># 最小空闲连接数 默认0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="ip限流"><a href="#ip限流" class="header-anchor">#</a> IP限流</h3> <blockquote><p>配置ip限流规则</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * ip限流
 * @return
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">KeyResolver</span> <span class="token function">ipKeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/*return exchange -&gt; Mono.just(exchange.getRequest().getRemoteAddress().getHostName());*/</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">KeyResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> hostName <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRemoteAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>hostName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>hostName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>yaml</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud.gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token comment"># 路由规则</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gateway<span class="token punctuation">-</span>service                              <span class="token comment"># 路由ID 唯一</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.consumer                          <span class="token comment"># 根据服务名称从注册中心获取服务请求地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>                                      <span class="token comment"># 断言</span>
            <span class="token punctuation">-</span> Path=/consumer/<span class="token important">**</span>                            <span class="token comment"># 匹配对应的URI请求 将匹配的请求追加到目标URI之后</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>                                         <span class="token comment"># 网关过滤器</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestRateLimiter                     <span class="token comment"># 限流过滤器</span>
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token key atrule">redis-rate-limiter.replenishRate</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token comment"># 令牌桶每秒填充速率</span>
                <span class="token key atrule">redis-rate-limiter.burstCapacity</span><span class="token punctuation">:</span> <span class="token number">2</span>        <span class="token comment"># 令牌桶总容量</span>
                <span class="token key atrule">key-resolver</span><span class="token punctuation">:</span> <span class="token string">&quot;#{@ipKeyResolver}&quot;</span>        <span class="token comment"># 使用 SpEL 表达式按名称引用bean</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
  <span class="token comment"># redis 缓存</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>              <span class="token comment"># 连接超时时间</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1             <span class="token comment"># Redis服务器地址</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>                  <span class="token comment"># Redis服务器端口</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">1</span>                 <span class="token comment"># 选择哪一个库 默认0</span>
    <span class="token key atrule">lettuce</span><span class="token punctuation">:</span>
      <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">1024</span>        <span class="token comment"># 最大连接数 默认8</span>
        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">10000</span>         <span class="token comment"># 最大连接阻塞等待时间 单位毫秒 默认-1</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">200</span>           <span class="token comment"># 最大空闲连接 默认8</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">5</span>             <span class="token comment"># 最小空闲连接数 默认0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><h3 id="sentinel限流"><a href="#sentinel限流" class="header-anchor">#</a> Sentinel限流</h3> <blockquote><p>创建新模块</p></blockquote> <blockquote><p>添加依赖</p></blockquote> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-spring-cloud-gateway-adapter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p>yaml配置</p></blockquote> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9001</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud.gateway.sentinel
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">filter</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">lower-case-service-id</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> cloud.consumer
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud.consumer
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/consumer/<span class="token important">**</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><blockquote><p>限流规则配置类</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>naihe<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>common<span class="token punctuation">.</span>rule<span class="token punctuation">.</span></span><span class="token class-name">GatewayFlowRule</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>common<span class="token punctuation">.</span>rule<span class="token punctuation">.</span></span><span class="token class-name">GatewayRuleManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>sc<span class="token punctuation">.</span></span><span class="token class-name">SentinelGatewayFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>sc<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">SentinelGatewayBlockExceptionHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">ObjectProvider</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">EnableAutoConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GlobalFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Ordered</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Order</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>codec<span class="token punctuation">.</span></span><span class="token class-name">ServerCodecConfigurer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>result<span class="token punctuation">.</span>view<span class="token punctuation">.</span></span><span class="token class-name">ViewResolver</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostConstruct</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashSet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @ProjectName SpringCloud_GateWay
 * @ClassName GatewayConfiguration
 * @Author NAIHE
 * @Date 2021-07-07
 * @Week 周三
 * @Time 下午 03:11
 * 限流规则配置类
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayConfiguration</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ViewResolver</span><span class="token punctuation">&gt;</span></span> viewResolvers<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServerCodecConfigurer</span> serverCodecConfigurer<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 构造器
     * @param viewResolversProvider
     * @param serverCodecConfigurer
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">GatewayConfiguration</span><span class="token punctuation">(</span><span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ViewResolver</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> viewResolversProvider<span class="token punctuation">,</span><span class="token class-name">ServerCodecConfigurer</span> serverCodecConfigurer<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>viewResolvers <span class="token operator">=</span> viewResolversProvider<span class="token punctuation">.</span><span class="token function">getIfAvailable</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token operator">::</span><span class="token function">emptyList</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serverCodecConfigurer <span class="token operator">=</span> serverCodecConfigurer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 限流异常处理器
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">HIGHEST_PRECEDENCE</span><span class="token punctuation">)</span> <span class="token comment">// 优先级</span>
    <span class="token keyword">public</span> <span class="token class-name">SentinelGatewayBlockExceptionHandler</span> <span class="token function">sentinelGatewayBlockExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SentinelGatewayBlockExceptionHandler</span><span class="token punctuation">(</span>viewResolvers<span class="token punctuation">,</span> serverCodecConfigurer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 限流过滤器
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">HIGHEST_PRECEDENCE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">GlobalFilter</span> <span class="token function">globalFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SentinelGatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * spring容器初始化的时候执行该方法
     * java自己的注解
     * 被@PostConstruct修饰的方法会在服务器加载Servlet的时候运行，并且只会被服务器执行一次。
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/*
          加载网关限流规则
         */</span>
        <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 网关限流规则
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayFlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/*
          resource：资源名称，可以是网关中的 routes 名称或者用户自定义的API分组名称
          count：限流阈值
          intervalSec：统计时间窗口，单位是秒，默认是1秒
         */</span>
        rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GatewayFlowRule</span><span class="token punctuation">(</span><span class="token string">&quot;cloud.consumer&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 限流阈值</span>
                <span class="token punctuation">.</span><span class="token function">setIntervalSec</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 统计时间窗口</span>
        <span class="token comment">// 加载网关限流规则</span>
        <span class="token class-name">GatewayRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><blockquote><p>启动类</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>naihe</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>naihe<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">GatewayConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">EnableDiscoveryClient</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @ProjectName SpringCloud_GateWay
 * @ClassName GatewaySentinelApplication
 * @Author NAIHE
 * @Date 2021-07-07
 * @Week 周三
 * @Time 下午 03:30
 */</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewaySentinelApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><code>如果启动报错，在配置类中添加@EnableAutoConfiguration注解</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span>ApplicationContextException</span><span class="token operator">:</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">start</span> reactive web server<span class="token punctuation">;</span> nested exception is <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span>ApplicationContextException</span><span class="token operator">:</span> <span class="token class-name">Unable</span> <span class="token keyword">to</span> <span class="token namespace">start</span> <span class="token class-name">ReactiveWebApplicationContext</span> due <span class="token keyword">to</span> <span class="token namespace">missing</span> <span class="token class-name">ReactiveWebServerFactory</span> bean<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>测试</p></blockquote> <p>访问：http://localhost:9001/consumer/list</p> <p>增加访问量</p> <img src="/study/assets/img/image-20210707154226142.e6986d47.png" alt="image-20210707154226142" style="zoom:67%;"> <h3 id="自定义异常信息"><a href="#自定义异常信息" class="header-anchor">#</a> 自定义异常信息</h3> <p>​	<code>GatewayCallbackManager</code> 的 <code>setBlockHander</code> 注册函数用于实现自定义的逻辑，处理被限流的请求</p> <blockquote><p>自定义限流异常处理器</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 自定义限流异常处理器
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">BlockRequestHandler</span> blockRequestHandler <span class="token operator">=</span> <span class="token punctuation">(</span>serverWebExchange<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUESTS</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUESTS</span><span class="token punctuation">.</span><span class="token function">getReasonPhrase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;route&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cloud.consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">TOO_MANY_REQUESTS</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">BodyInserters</span><span class="token punctuation">.</span><span class="token function">fromObject</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 加载自定义限流异常处理器</span>
    <span class="token class-name">GatewayCallbackManager</span><span class="token punctuation">.</span><span class="token function">setBlockHandler</span><span class="token punctuation">(</span>blockRequestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><em>在 doInit 中加载自定义限流方法</em></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * spring容器初始化的时候执行该方法
 * java自己的注解
 * 被@PostConstruct修饰的方法会在服务器加载Servlet的时候运行，并且只会被服务器执行一次。
 */</span>
<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/*
       加载网关限流规则
     */</span>
    <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
       加载自定义限流
     */</span>
    <span class="token function">initBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>结果</p></blockquote> <img src="/study/assets/img/image-20210707161716067.f01dd173.png" alt="image-20210707161716067" style="zoom:80%;"> <h3 id="分组限流"><a href="#分组限流" class="header-anchor">#</a> 分组限流</h3> <blockquote><p>配置类中添加限流分组配置</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 限流分组
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initCustomizedApis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApiDefinition</span><span class="token punctuation">&gt;</span></span> definitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// provider 组</span>
    <span class="token class-name">ApiDefinition</span> api1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiDefinition</span><span class="token punctuation">(</span><span class="token string">&quot;provider-api&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setPredicateItems</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApiPredicateItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
            <span class="token comment">// 匹配 /cloud.provider/product/list 以及其子路径的所有请求</span>
            <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApiPathPredicateItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPattern</span><span class="token punctuation">(</span><span class="token string">&quot;/cloud.provider/product/**&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setMatchStrategy</span><span class="token punctuation">(</span><span class="token class-name">SentinelGatewayConstants</span><span class="token punctuation">.</span><span class="token constant">URL_MATCH_STRATEGY_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// consumer 组</span>
    <span class="token class-name">ApiDefinition</span> api2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiDefinition</span><span class="token punctuation">(</span><span class="token string">&quot;consumer-api&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setPredicateItems</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApiPredicateItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
            <span class="token comment">// 只匹配 /cloud.consumer/consumer/index 请求</span>
            <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApiPathPredicateItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPattern</span><span class="token punctuation">(</span><span class="token string">&quot;/cloud.consumer/consumer/index&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    definitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>api1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    definitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>api2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 加载限流分组</span>
    <span class="token class-name">GatewayApiDefinitionManager</span><span class="token punctuation">.</span><span class="token function">loadApiDefinitions</span><span class="token punctuation">(</span>definitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><blockquote><p>修改网关限流规则</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 网关限流规则
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initGatewayRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GatewayFlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
          resource：资源名称，可以是网关中的 routes 名称或者用户自定义的API分组名称
          count：限流阈值
          intervalSec：统计时间窗口，单位是秒，默认是1秒
         */</span>
    rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GatewayFlowRule</span><span class="token punctuation">(</span><span class="token string">&quot;cloud.consumer&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// 限流阈值</span>
              <span class="token punctuation">.</span><span class="token function">setIntervalSec</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 统计时间窗口</span>
    rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GatewayFlowRule</span><span class="token punctuation">(</span><span class="token string">&quot;cloud.provider&quot;</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">// 限流阈值</span>
              <span class="token punctuation">.</span><span class="token function">setIntervalSec</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 统计时间窗口</span>
    <span class="token comment">// 加载网关限流规则</span>
    <span class="token class-name">GatewayRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 加载限流分组</span>
    <span class="token function">initCustomizedApis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><blockquote><p>重启服务，测试</p></blockquote> <h2 id="高可用网关"><a href="#高可用网关" class="header-anchor">#</a> 高可用网关</h2> <p>​	业内通常用多少g来衡量网站的可用性，例如：QQ的可用性为4个9，就是说QQ能够保证在一年时间里，服务在99.99%的时间是可用的，只有0.01%的时间是不可用，大约最多53分钟</p> <p>​	对于大多数网站，2个9是基本可用；3个9为高可用；4个9是拥有自动恢复能力的高可用</p> <p>​	实现高可用的主要手段是<code>数据的冗余备份</code>和<code>服务的失效转移</code>，这两种手段具体怎么做？在网关里如何体现？主要有以下几个方向：</p> <ul><li>集群部署</li> <li>负载均衡</li> <li>健康检查</li> <li>节点自动重启</li> <li>熔断</li> <li>服务降级</li> <li>接口重试</li></ul> <h3 id="nginx-网关集群实现高可用网关"><a href="#nginx-网关集群实现高可用网关" class="header-anchor">#</a> Nginx + 网关集群实现高可用网关</h3> <img src="/study/assets/img/image-20210707165651677.a3324be2.png" alt="image-20210707165651677" style="zoom:80%;"> <blockquote><p>配置Nginx网关集群</p></blockquote> <div class="language-xml-dtd line-numbers-mode"><pre class="language-text"><code>worker_processes  1;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    # 网关集群
    upstream gateway {
    	server 127.0.0.1:9000;
    	server 127.0.0.1:9001;
    }

    # 端口
    server {
        listen       8088;
        server_name  localhost;

		# 代理网关集群，负载均衡调用
        location / {
        	proxy_pass http://gateway;
        }
    }

}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><blockquote><p>启动服务，访问</p></blockquote> <p>http://localhost:8088/cloud.consumer/consumer/list?token=123&amp;name=naihe</p> <p>http://localhost:8088/cloud.provider/product/list</p> <img src="/study/assets/img/image-20210708085238254.995cef01.png" alt="image-20210708085238254" style="zoom:80%;"> <blockquote><p>总结</p></blockquote> <p>​	一个请求过来，首先经过Nginx的一层负载，到达网关，然后由网关负载到真实后端，若后端有问题，网关会进行重试访问，多次访问后仍返回失败，可以通过熔断或服务降级立即返回结果，由于是负载均衡，网关重试时不一定会访问到出错的后端</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/study/assets/js/app.18d9f44d.js" defer></script><script src="/study/assets/js/2.da4bf759.js" defer></script><script src="/study/assets/js/1.32610913.js" defer></script><script src="/study/assets/js/12.5fdd5129.js" defer></script>
  </body>
</html>
